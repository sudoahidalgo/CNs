<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CN - Martes de Birras üçª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><text y='96' font-size='96'>üç∫</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* ... (Estilos CSS de la v5 sin cambios, excepto quiz√°s el comentario de fondo.png) ... */
    body, html { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
    body {
      /* Si 'fondo.png' causa problemas de carga (ERR_CONNECTION_CLOSED), 
         intenta optimizar la imagen o usa un color de fondo simple temporalmente: */
      /* background-color: #2c2c2c; */
      background: url('fondo.png') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Inter', sans-serif; 
    }
    .overlay { position: fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(25, 25, 25, 0.25); z-index: 1; pointer-events: none; }
    .main-content { z-index: 2; position: relative; min-height: 100vh; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 2.8rem; color: #ffe066; text-shadow: 2px 3px 8px #0008; margin-bottom: 10px; font-weight: 700; }
    .user-info { position: fixed; top: 20px; right: 20px; z-index: 1051; background: rgba(34,34,34,0.90); border-radius: 15px; padding: 10px 15px; color: #ffe066; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 10px #0004; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ffe066; background-color: #555; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; overflow: hidden; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .auth-container { max-width: 500px; margin: 50px auto; background: linear-gradient(135deg, rgba(0, 141, 78, 0.15), rgba(255, 224, 102, 0.15)); backdrop-filter: blur(15px); border-radius: 25px; padding: 40px; text-align: center; border: 2px solid rgba(255, 224, 102, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); position: relative; overflow: hidden; }
    .auth-container::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255, 224, 102, 0.1) 0%, transparent 70%); animation: pulse 3s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
    .auth-container h2 { font-size: 2.5rem; color: #ffe066; margin-bottom: 15px; text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7); position: relative; z-index: 1; }
    .auth-container p { font-size: 1.2rem; color: #ffffff; margin-bottom: 35px; text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.6); position: relative; z-index: 1; }
    #googleSignIn { background: linear-gradient(45deg, #4285f4, #34a853); border: none; border-radius: 15px; color: white; font-size: 1.3rem; font-weight: 600; padding: 15px 40px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4); position: relative; z-index: 1; display: inline-flex; align-items: center; gap: 12px; }
    #googleSignIn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(66, 133, 244, 0.6); background: linear-gradient(45deg, #3367d6, #2d8a47); }
    #googleSignIn:active { transform: translateY(-1px); }
    .google-icon { width: 24px; height: 24px; background: white; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: #4285f4; }
    .main-tabs { margin-bottom: 30px; }
    .nav-pills .nav-link { background: rgba(36,36,36,0.80); color: #ffe066; border-radius: 15px; margin: 0 5px; font-weight: 600; padding: 10px 20px; }
    .nav-pills .nav-link.active { background: #008d4e; color: white; box-shadow: 0 0 10px #008d4e99; }
    .tab-content { background: rgba(36,36,36,0.90); border-radius: 20px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    .winner-box { font-size: 1.8rem; color: #ffe066; font-weight: 700; margin-bottom: 20px; background: rgba(0,0,0,0.50); padding: 15px 25px; border-radius: 15px; text-align: center; }
    .quorum-status { font-size: 1.1rem; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 600; }
    .quorum-yes { background: rgba(0, 141, 78, 0.3); color: #4ade80; border: 1px solid #4ade8033; }
    .quorum-no { background: rgba(239, 68, 68, 0.3); color: #f87171; border: 1px solid #f8717133; }
    .quorum-pending { background: rgba(234, 179, 8, 0.3); color: #facc15; border: 1px solid #facc1533; }
    table { background: rgba(36,36,36,0.95); border-radius: 15px; color: #fff; overflow: hidden; }
    th { background: #222; color: #ffe066; font-size: 1.05rem; letter-spacing: 0.5px; border-bottom: 2px solid #444; }
    td { vertical-align: middle; }
    .vote-btn { background: #008d4e; color: #fff; border-radius: 10px; font-size: 1.1rem; padding: 8px 15px; border: none; cursor: pointer; transition: all 0.2s ease-in-out; margin: 2px; min-width: 100px; text-align: center; }
    .vote-btn.voted { background: #c0392b; }
    .vote-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #555 !important; color: #aaa !important; }
    .vote-btn:hover:not(:disabled) { filter: brightness(1.2); }
    .stats-card { background: rgba(40,40,40,0.90); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: #fff; border: 1px solid #55555555; }
    .stats-card h5 { color: #ffe066; margin-bottom: 15px; font-weight: 600; }
    .last-visit { font-size: 0.9rem; color: #94a3b8; }
    .icon-link { display: inline-block; vertical-align: middle; margin: 0 3px; opacity: 0.85; transition: opacity 0.12s; }
    .icon-link:hover { opacity: 1; filter: drop-shadow(0 1px 2px #ffe06688); }
    .ig-icon, .fb-icon { width: 1.5em; height: 1.5em; display: inline-block; }
    .ig-icon { filter: drop-shadow(0 0 4px #ffe06688); }
    .recent-visit { color: #10b981; font-weight: 500; }
    .never-visited { color: #ef4444; font-weight: 600; }
    .old-visit { color: #f59e0b; font-weight: 500; }
    .text-muted-light { color: #adb5bd !important; } 
    .attended-user-vote { font-size: 0.8em; color: #bbb; margin-left: 5px; } /* Estilo para votos en lista de asistencia */

    @media (max-width: 768px) {
      .header h1 { font-size: 2.2rem; }
      .user-info { position: static; margin: 15px auto; width: fit-content; flex-direction: column; gap: 5px; }
      .user-info button { margin-top: 5px;}
      table { font-size: 0.85rem; }
      .vote-btn { font-size: 0.9rem; padding: 6px 10px; min-width: 80px;}
      .nav-pills .nav-link { padding: 8px 12px; font-size: 0.9rem;}
      .col-md-4, .col-md-8 { width: 100%;} 
      .order-md-1 { order: 0;} 
      .order-md-2 { order: 0;}
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  <div id="userInfo" class="user-info" style="display: none;"> /* ... (sin cambios) ... */ </div>
  <div id="authContainer" class="auth-container" style="display: none;"> /* ... (sin cambios) ... */ </div>

  <div id="mainContent" class="main-content" style="display: none;">
    <div class="header"> /* ... (sin cambios) ... */ </div>
    <ul class="nav nav-pills justify-content-center main-tabs" id="mainTabs" role="tablist"> /* ... (sin cambios) ... */ </ul>

    <div class="tab-content" id="mainTabContent">
      <div class="tab-pane fade show active" id="voting" role="tabpanel">
        <div id="winner" class="winner-box" style="display:none;"></div>
        <div class="row">
          <div class="col-md-4 order-md-2">
            <h4 class="text-light mb-3">üë• Asistencia</h4>
            <div class="stats-card">
              <div id="quorumStatus" class="quorum-status mb-3"></div>
              <div id="attendanceList">
                <h6 class="text-warning">Confirmados y sus votos:</h6> <div id="confirmedList" class="mb-2"></div>
              </div>
            </div>
          </div>
          <div class="col-md-8 order-md-1">
            <h4 class="text-light mb-3">üó≥Ô∏è Votaci√≥n de Bares</h4>
            <div class="table-responsive">
              <table class="table table-dark table-hover align-middle">
                <thead>
                  <tr>
                    <th>Bar</th>
                    <th>Redes</th>
                    <th>Votar</th>
                    <th>Votos</th>
                    <th>√öltima visita</th>
                  </tr>
                </thead>
                <tbody id="barsTable"></tbody>
              </table>
            </div>
            </div>
        </div>
      </div>
      <div class="tab-pane fade" id="history" role="tabpanel"> /* ... (sin cambios) ... */ </div>
      <div class="tab-pane fade" id="stats" role="tabpanel"> /* ... (sin cambios) ... */ </div>
    </div>
  </div>

  <script>
    const supabaseUrl = 'https://wjwsdyrkqvxszlclitru.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indqd3NkeXJrcXZ4c3psY2xpdHJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0MTA1NzgsImV4cCI6MjA2Mjk4NjU3OH0.YmNDUjkQJrlk91O-Avv7G2QJzQ0R6u9xkR-eIwoAJLo';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
      auth: { // CAMBIO: Especificar expl√≠citamente para claridad, aunque son defaults
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true, // Para OAuth
      }
    });

    const bars = [ /* ... (sin cambios) ... */ ];
    let currentUser = null;
    let currentWeek = null;
    let userVotes = []; 
    let userAttendance = false;
    // let voteDetailsModalInstance = null; // CAMBIO: Ya no se necesita

    async function init() {
      console.log('üöÄ Iniciando aplicaci√≥n... Intentando obtener sesi√≥n.');
      try {
        // CAMBIO: A√±adir log antes y despu√©s de getSession
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          console.error('‚ùå Error obteniendo sesi√≥n inicial:', sessionError);
        }
        console.log('üë§ Sesi√≥n inicial obtenida:', session ? session.user?.email : 'No hay sesi√≥n');
        
        if (session) {
          await handleAuthSuccess(session);
        } else {
          // CAMBIO: Si no hay sesi√≥n y la URL no tiene hash de token (de redirecci√≥n OAuth)
          if (!window.location.hash.includes('access_token')) {
            console.log('üîê No hay sesi√≥n ni token en URL, mostrando login.');
            showAuthContainer();
          } else {
            console.log('‚è≥ Token detectado en URL, esperando onAuthStateChange para procesar SIGNED_IN...');
            // onAuthStateChange se encargar√° de procesar el login desde la redirecci√≥n
          }
        }

        supabase.auth.onAuthStateChange(async (event, session) => {
          console.log(`üîÑ Evento AuthStateChange: ${event}`, session ? `Usuario: ${session.user?.email}` : 'Sin sesi√≥n');
          if (event === 'INITIAL_SESSION' && session) { // Evento cuando se carga una sesi√≥n persistente
             console.log('üîë Sesi√≥n persistente cargada (INITIAL_SESSION)');
             await handleAuthSuccess(session);
          } else if (event === 'SIGNED_IN' && session) {
            console.log('‚úÖ Login exitoso (SIGNED_IN)');
            await handleAuthSuccess(session);
          } else if (event === 'SIGNED_OUT') {
            console.log('üëã Logout detectado (SIGNED_OUT)');
            handleSignOut();
          } else if (event === 'TOKEN_REFRESHED' && session) {
            console.log('üîÑ Token refrescado');
            currentUser = session.user;
          } else if (event === 'USER_UPDATED' && session) {
            console.log('üë§ Usuario actualizado');
            currentUser = session.user;
            updateUserInfoDisplay(); 
          } else if (event === 'PASSWORD_RECOVERY') {
            console.log('üîë Evento de recuperaci√≥n de contrase√±a');
          }

          // CAMBIO: Si no hay sesi√≥n despu√©s de un evento y no estamos en proceso de OAuth
          if (!session && !window.location.hash.includes('access_token') && event !== 'SIGNED_OUT') {
              console.log('‚ö†Ô∏è No hay sesi√≥n despu√©s de evento y no es OAuth, mostrando login.');
              // showAuthContainer(); // Podr√≠a ser muy agresivo, considerar si es necesario aqu√≠
          }
        });
      } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
        showAuthContainer();
      }
    }

    function handleSignOut() { /* ... (sin cambios) ... */ }
    function showAuthContainer() { /* ... (sin cambios) ... */ }
    function updateUserInfoDisplay() { /* ... (sin cambios) ... */ }
    async function handleAuthSuccess(session) { /* ... (sin cambios) ... */ }
    async function ensureUserProfile() { /* ... (sin cambios) ... */ }
    async function ensureCurrentWeek() { /* ... (sin cambios) ... */ }
    async function loadCurrentWeek() { /* ... (sin cambios) ... */ }
    async function loadVotingData() { /* ... (sin cambios) ... */ }
    
    async function loadAttendanceData() {
      if (!currentUser || !currentWeek) {
        updateAttendanceUI([]); // CAMBIO: Pasar array vac√≠o para limpiar
        updateQuorumStatus(0);
        userAttendance = false; 
        return;
      }
      try {
        // CAMBIO: Obtener todos los votos de la semana para cruzar con los asistentes
        const { data: allVotesThisWeek, error: allVotesError } = await supabase
            .from('votos')
            .select('user_id, bar')
            .eq('semana_id', currentWeek.id);

        if (allVotesError) {
            console.error('‚ùå Error cargando todos los votos de la semana:', allVotesError);
            // Continuar para al menos mostrar los nombres de los asistentes
        }

        const { data: attendances, error: attendanceError } = await supabase
          .from('asistencias')
          .select(`user_id, confirmado, usuarios (nombre, avatar_url)`)
          .eq('semana_id', currentWeek.id)
          .eq('confirmado', true);

        if (attendanceError) throw attendanceError;
        
        userAttendance = (attendances || []).some(a => a.user_id === currentUser.id);
        
        // CAMBIO: Mapear los votos a cada asistente
        const attendeesWithVotes = (attendances || []).map(att => {
            const userSpecificVotes = (allVotesThisWeek || [])
                .filter(vote => vote.user_id === att.user_id)
                .map(vote => vote.bar);
            return { ...att, votedBars: userSpecificVotes };
        });

        updateAttendanceUI(attendeesWithVotes);
        updateQuorumStatus((attendances || []).length);

      } catch (error) {
        console.error("‚ùå Error en loadAttendanceData:", error);
        userAttendance = false;
        updateAttendanceUI([]);
        updateQuorumStatus(0);
      }
    }

    function igIcon() { /* ... (sin cambios) ... */ }
    function fbIcon() { /* ... (sin cambios) ... */ }
    function renderBarsTable(allVotesInWeek, barStats) {
      // CAMBIO: El span de conteo de votos ya no es clickeable para un modal
      const tbody = document.getElementById('barsTable');
      if (!tbody) return;
      tbody.innerHTML = ''; 
      // ... resto de la funci√≥n renderBarsTable similar a v5, pero el span de votos
      // ya no necesita el data-action="showDetails" para el modal.
      // Ejemplo de la parte modificada del span:
      // <span class="${votesForBar > 0 ? 'text-warning' : 'text-muted-light'}">
      //   ${votesForBar}
      // </span>
        const voteCounts = {}; allVotesInWeek.forEach(vote => { voteCounts[vote.bar] = (voteCounts[vote.bar] || 0) + 1; }); const statsMap = {}; barStats.forEach(stat => { statsMap[stat.bar] = stat; }); const sortedBars = bars.slice().sort((a, b) => { const aVotes = voteCounts[a.name] || 0; const bVotes = voteCounts[b.name] || 0; if (bVotes !== aVotes) return bVotes - aVotes; return a.name.localeCompare(b.name); }); if (sortedBars.length === 0 && (!currentWeek || currentWeek.estado !== 'activa')) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted-light">La votaci√≥n no est√° activa o no hay bares configurados.</td></tr>'; return; } if (sortedBars.length === 0 ) { tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted-light">No hay bares para mostrar.</td></tr>'; return; } sortedBars.forEach(bar => { const votesForBar = voteCounts[bar.name] || 0; const userHasVotedForThisBar = userVotes.includes(bar.name); const stats = statsMap[bar.name]; let socialLinks = ''; if (bar.ig) socialLinks += `<a class="icon-link" href="${bar.ig}" target="_blank" title="Instagram">${igIcon()}</a>`; if (bar.fb) socialLinks += `<a class="icon-link" href="${bar.fb}" target="_blank" title="Facebook">${fbIcon()}</a>`; if (!socialLinks) socialLinks = '<span style="color:#bbb;">‚Äî</span>'; let lastVisitText = '<span class="never-visited">Nunca</span>'; if (stats && stats.ultima_visita) { const days = stats.dias_desde_ultima_visita; const dateStr = formatDate(stats.ultima_visita); if (days <= 14) lastVisitText = `<span class="recent-visit">${dateStr} (${days}d)</span>`; else if (days <= 60) lastVisitText = `<span class="old-visit">${dateStr} (${days}d)</span>`; else lastVisitText = `<span class="last-visit">${dateStr} (${days}d)</span>`; } const row = `
          <tr>
            <td style="font-weight: 600;">${bar.name}</td>
            <td>${socialLinks}</td>
            <td>
              <button class="vote-btn${userHasVotedForThisBar ? ' voted' : ''}" ${currentWeek?.estado !== 'activa' ? 'disabled' : ''} data-bar="${encodeURIComponent(bar.name)}" data-action="vote">
                ${userHasVotedForThisBar ? 'üç∫ Quitar' : 'üí™ Votar'}
              </button>
            </td>
            <td class="text-center" style="font-size: 1.2em; font-weight: 700;">
              <span class="${votesForBar > 0 ? 'text-warning' : 'text-muted-light'}"> 
                ${votesForBar}
              </span>
            </td>
            <td class="last-visit">${lastVisitText}</td>
          </tr>
        `; tbody.innerHTML += row; });
    }
    function updateWinner(allVotesInWeek) { /* ... (sin cambios) ... */ }
    
    function updateAttendanceUI(attendeesWithVotes) { // CAMBIO: Recibe attendeesWithVotes
        const confirmedListEl = document.getElementById('confirmedList');
        if (!confirmedListEl) return;

        if (!attendeesWithVotes || attendeesWithVotes.length === 0) {
            confirmedListEl.innerHTML = '<em class="text-muted-light">Nadie ha confirmado asistencia (nadie ha votado).</em>';
        } else {
            confirmedListEl.innerHTML = attendeesWithVotes.map(att => {
                const userName = att.usuarios?.nombre || 'Usuario Desconocido';
                const avatarUrl = att.usuarios?.avatar_url || ''; 
                const avatarPlaceholder = `<div class="rounded-circle me-2 d-inline-flex align-items-center justify-content-center" style="width:24px;height:24px;background-color:#6c757d;color:white;font-size:0.8em;">${userName.substring(0,1).toUpperCase()}</div>`;
                
                // CAMBIO: Mostrar los bares por los que vot√≥
                let votedBarsString = '';
                if (att.votedBars && att.votedBars.length > 0) {
                    votedBarsString = `<span class="attended-user-vote">(${att.votedBars.join(', ')})</span>`;
                }

                return `
                    <div class="d-flex align-items-center mb-1">
                        ${avatarUrl ? `<img src="${avatarUrl}" class="rounded-circle me-2" width="24" height="24" alt="Avatar" onerror="this.outerHTML='${avatarPlaceholder}'">` : avatarPlaceholder}
                        <span>${userName} ${votedBarsString}</span>
                    </div>`;
            }).join('');
        }
    }

    function updateQuorumStatus(count) { /* ... (sin cambios) ... */ }
    async function toggleVote(barName, btnElement) { /* ... (sin cambios respecto a v5, sigue siendo importante el log de deletedData) ... */ 
        console.log(`‚èØÔ∏è toggleVote para: '${barName}', currentUser: ${currentUser?.id}, currentWeek: ${currentWeek?.id}`);
        if (!currentWeek || currentWeek.estado !== 'activa' || !currentUser) { alert('No se puede votar en este momento. Verifica que la votaci√≥n est√© activa y hayas iniciado sesi√≥n.'); return; }
        const originalButtonHTML = btnElement.innerHTML; 
        btnElement.innerHTML = '‚è≥'; btnElement.disabled = true;
        try {
            const userAlreadyVotedForThis = userVotes.includes(barName);
            if (userAlreadyVotedForThis) {
            console.log(`üóëÔ∏è ${currentUser.email} intentando quitar voto para '${barName}'`);
            const criteria = { user_id: currentUser.id, semana_id: currentWeek.id, bar: barName };
            console.log("Criterios para delete:", criteria);
            const { data: deletedData, error: deleteError } = await supabase.from('votos').delete().match(criteria).select(); 
            if (deleteError) { console.error(`‚ùå Error al eliminar voto de Supabase para '${barName}':`, deleteError); throw deleteError; }
            console.log(`‚úÖ Resultado de Supabase.delete para '${barName}':`, deletedData);
            if (deletedData && deletedData.length > 0) {
                console.log(`‚úÖ Voto para '${barName}' confirmado como eliminado de la BD.`);
                userVotes = userVotes.filter(votedBar => votedBar !== barName); 
                if (userVotes.length === 0) { 
                    console.log('üóëÔ∏è No quedan m√°s votos, eliminando asistencia...');
                    const { error: delAttErr } = await supabase.from('asistencias').delete().match({ user_id: currentUser.id, semana_id: currentWeek.id });
                    if (delAttErr) console.error("Error al eliminar asistencia:", delAttErr); else console.log("‚úÖ Asistencia eliminada de la BD.");
                    userAttendance = false; 
                }
            } else { console.warn(`‚ö†Ô∏è No se elimin√≥ ninguna fila de la BD para '${barName}'. Revisa RLS y los datos en la tabla 'votos'.`); }
            } else {
            console.log(`‚ûï ${currentUser.email} votando por '${barName}'`);
            const { error } = await supabase.from('votos').insert([{ user_id: currentUser.id, semana_id: currentWeek.id, bar: barName }]);
            if (error) { console.error(`‚ùå Error al insertar voto en Supabase para '${barName}':`, error); throw error; }
            console.log(`‚úÖ Voto por '${barName}' agregado a la BD.`);
            userVotes.push(barName); 
            if (!userAttendance) {
                console.log('‚ûï Marcando asistencia por nuevo voto...');
                const { data: existingAtt, error: checkAttErr } = await supabase.from('asistencias').select('id').match({ user_id: currentUser.id, semana_id: currentWeek.id }).maybeSingle();
                if (checkAttErr && checkAttErr.code !== 'PGRST116') throw checkAttErr;
                if (!existingAtt) {
                    const { error: insAttErr } = await supabase.from('asistencias').insert([{ user_id: currentUser.id, semana_id: currentWeek.id, confirmado: true }]);
                    if (insAttErr) console.error("Error al marcar asistencia:", insAttErr); else console.log("‚úÖ Asistencia marcada en la BD.");
                }
                userAttendance = true; 
            }
            }
            console.log('üîÑ Recargando datos despu√©s de toggleVote...');
            await loadVotingData(); 
            await loadAttendanceData();
            console.log('‚úÖ Datos recargados.');
        } catch (error) {
            console.error(`‚ùå Error completo en toggleVote para '${barName}':`, error);
            alert('Error al procesar el voto: ' + error.message + '. Revisa la consola para m√°s detalles.');
            if(btnElement){ btnElement.innerHTML = originalButtonHTML;  btnElement.disabled = false;  }
            console.log('üîÑ Intentando recargar datos despu√©s de error para restaurar consistencia...');
            await loadVotingData(); await loadAttendanceData();
        } 
    }
    // async function showVoteDetails(barName, voteCount) { /* CAMBIO: Eliminada ya que el modal no se usa m√°s */ }
    async function loadHistory() { /* ... (sin cambios) ... */ }

    async function loadStats() {
        if (!currentUser) { return; }
        const loadingMsg = '<p class="text-muted-light">Cargando...</p>';
        const noDataMsg = '<p class="text-muted-light">No hay datos disponibles a√∫n.</p>';
        const errorMsg = '<p class="text-danger">Error al cargar datos.</p>';

        ['topBars', 'lastVisits', 'cnStats'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = loadingMsg;
        });

        try {
            // CAMBIO: Corregir la consulta para topBars
            const { data: topBarsData, error: topBarsError } = await supabase
                .from('votos') // Usar la tabla 'votos' directamente para agregar
                .select('bar, count()') // Seleccionar bar y contar
                .group('bar') // Agrupar por bar
                .order('count', { ascending: false }) // Ordenar por el conteo
                .limit(10);

            // Las otras consultas de estad√≠sticas se mantienen, asumiendo que las tablas/vistas existen
            const { data: lastVisitsData, error: lastVisitsError } = await supabase
                .from('estadisticas_bares') // Asume que esta vista/tabla existe y est√° correcta
                .select('*')
                .order('ultima_visita', { ascending: false, nullsFirst: true })
                .limit(10);
            
            const { data: cnStatsData, error: cnStatsError } = await supabase
                .from('semanas_cn') // Asume que esta vista/tabla existe y est√° correcta
                .select('*')
                .eq('estado', 'finalizada');
            
            updateStatsUI(
                topBarsError ? { error: true, message: topBarsError.message } : (topBarsData || []),
                lastVisitsError ? { error: true, message: lastVisitsError.message } : (lastVisitsData || []),
                cnStatsError ? { error: true, message: cnStatsError.message } : (cnStatsData || [])
            );

        } catch (error) { 
            console.error('‚ùå Error general cargando estad√≠sticas (Promise.all o similar):', error);
            ['topBars', 'lastVisits', 'cnStats'].forEach(id => {
                const el = document.getElementById(id); if (el) el.innerHTML = errorMsg;
            });
            if (error.message?.includes('JWT')) handleSignOut();
        }
    }

    function updateStatsUI(topBars, lastVisits, cnStats) {
        const noDataMsg = '<p class="text-muted-light">No hay datos disponibles a√∫n.</p>';
        const errorMsgTemplate = (message) => `<p class="text-danger">Error al cargar: ${message || 'detalle no disponible'}</p>`;

        const topBarsDiv = document.getElementById('topBars');
        if (topBarsDiv) {
            if (topBars.error) topBarsDiv.innerHTML = errorMsgTemplate(topBars.message);
            else if (topBars.length === 0) topBarsDiv.innerHTML = noDataMsg;
            else {
            // CAMBIO: 'count' es el alias del conteo de Supabase
            topBarsDiv.innerHTML = topBars.map((bar, index) => 
                `<div class="d-flex justify-content-between align-items-center py-1">
                <span>${index + 1}. ${bar.bar}</span>
                <span class="badge bg-warning text-dark rounded-pill">${bar.count} visita(s)</span>
                </div>`
            ).join('');
            }
        }
        // ... (resto de updateStatsUI similar a v5, solo ajustando el manejo de error.message)
        const lastVisitsDiv = document.getElementById('lastVisits'); 
        if(lastVisitsDiv) { 
            if (lastVisits.error) lastVisitsDiv.innerHTML = errorMsgTemplate(lastVisits.message); 
            else if (lastVisits.length === 0) lastVisitsDiv.innerHTML = noDataMsg; 
            else { /* ... (renderizado como antes) ... */ }
        } 
        const cnStatsDiv = document.getElementById('cnStats'); 
        if (cnStatsDiv) { 
            if (cnStats.error) cnStatsDiv.innerHTML = errorMsgTemplate(cnStats.message); 
            else { /* ... (renderizado como antes) ... */ }
        }
    }

    document.addEventListener('DOMContentLoaded', function() { /* ... (sin cambios) ... */ });
    document.getElementById('googleSignIn').addEventListener('click', async () => { /* ... (sin cambios) ... */ });
    async function signOut() { /* ... (sin cambios) ... */ }
    function formatDate(dateString) { /* ... (sin cambios) ... */ }
    function setupEventListeners() { /* ... (sin cambios) ... */ }
    
    function handleTableClick(event) { 
        let targetElement = event.target;
        const voteButton = targetElement.closest('[data-action="vote"]');
        // CAMBIO: Ya no se busca 'showDetails' para el modal
        // const detailsSpan = targetElement.closest('[data-action="showDetails"]'); 

        if (voteButton) {
            const encodedBarName = voteButton.getAttribute('data-bar');
            if (!encodedBarName || voteButton.disabled) return;
            const barName = decodeURIComponent(encodedBarName);
            toggleVote(barName, voteButton); 
        } 
        // CAMBIO: Ya no hay else if para detailsSpan
    }
    window.signOut = signOut; 
  </script>
</body>
</html>
