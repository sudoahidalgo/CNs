<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CN - Martes de Birras üçª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><text y='96' font-size='96'>üç∫</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* ... (Estilos CSS de la v6 sin cambios) ... */
    body, html { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
    body {
      background: url('fondo.png') no-repeat center center fixed;
      background-size: cover;
      font-family: 'Inter', sans-serif; 
    }
    .overlay { position: fixed; top:0; left:0; width:100vw; height:100vh; background: rgba(25, 25, 25, 0.25); z-index: 1; pointer-events: none; }
    .main-content { z-index: 2; position: relative; min-height: 100vh; padding: 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 2.8rem; color: #ffe066; text-shadow: 2px 3px 8px #0008; margin-bottom: 10px; font-weight: 700; }
    .user-info { position: fixed; top: 20px; right: 20px; z-index: 1051; background: rgba(34,34,34,0.90); border-radius: 15px; padding: 10px 15px; color: #ffe066; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 10px #0004; }
    .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid #ffe066; background-color: #555; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; overflow: hidden; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .auth-container { max-width: 500px; margin: 50px auto; background: linear-gradient(135deg, rgba(0, 141, 78, 0.15), rgba(255, 224, 102, 0.15)); backdrop-filter: blur(15px); border-radius: 25px; padding: 40px; text-align: center; border: 2px solid rgba(255, 224, 102, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); position: relative; overflow: hidden; }
    .auth-container::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255, 224, 102, 0.1) 0%, transparent 70%); animation: pulse 3s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
    .auth-container h2 { font-size: 2.5rem; color: #ffe066; margin-bottom: 15px; text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7); position: relative; z-index: 1; }
    .auth-container p { font-size: 1.2rem; color: #ffffff; margin-bottom: 35px; text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.6); position: relative; z-index: 1; }
    #googleSignIn { background: linear-gradient(45deg, #4285f4, #34a853); border: none; border-radius: 15px; color: white; font-size: 1.3rem; font-weight: 600; padding: 15px 40px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4); position: relative; z-index: 1; display: inline-flex; align-items: center; gap: 12px; }
    #googleSignIn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(66, 133, 244, 0.6); background: linear-gradient(45deg, #3367d6, #2d8a47); }
    #googleSignIn:active { transform: translateY(-1px); }
    .google-icon { width: 24px; height: 24px; background: white; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; color: #4285f4; }
    .main-tabs { margin-bottom: 30px; }
    .nav-pills .nav-link { background: rgba(36,36,36,0.80); color: #ffe066; border-radius: 15px; margin: 0 5px; font-weight: 600; padding: 10px 20px; }
    .nav-pills .nav-link.active { background: #008d4e; color: white; box-shadow: 0 0 10px #008d4e99; }
    .tab-content { background: rgba(36,36,36,0.90); border-radius: 20px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    .winner-box { font-size: 1.8rem; color: #ffe066; font-weight: 700; margin-bottom: 20px; background: rgba(0,0,0,0.50); padding: 15px 25px; border-radius: 15px; text-align: center; }
    .quorum-status { font-size: 1.1rem; padding: 10px 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; font-weight: 600; }
    .quorum-yes { background: rgba(0, 141, 78, 0.3); color: #4ade80; border: 1px solid #4ade8033; }
    .quorum-no { background: rgba(239, 68, 68, 0.3); color: #f87171; border: 1px solid #f8717133; }
    .quorum-pending { background: rgba(234, 179, 8, 0.3); color: #facc15; border: 1px solid #facc1533; }
    table { background: rgba(36,36,36,0.95); border-radius: 15px; color: #fff; overflow: hidden; }
    th { background: #222; color: #ffe066; font-size: 1.05rem; letter-spacing: 0.5px; border-bottom: 2px solid #444; }
    td { vertical-align: middle; }
    .vote-btn { background: #008d4e; color: #fff; border-radius: 10px; font-size: 1.1rem; padding: 8px 15px; border: none; cursor: pointer; transition: all 0.2s ease-in-out; margin: 2px; min-width: 100px; text-align: center; }
    .vote-btn.voted { background: #c0392b; }
    .vote-btn:disabled { opacity: 0.5; cursor: not-allowed; background: #555 !important; color: #aaa !important; }
    .vote-btn:hover:not(:disabled) { filter: brightness(1.2); }
    .stats-card { background: rgba(40,40,40,0.90); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: #fff; border: 1px solid #55555555; }
    .stats-card h5 { color: #ffe066; margin-bottom: 15px; font-weight: 600; }
    .last-visit { font-size: 0.9rem; color: #94a3b8; }
    .icon-link { display: inline-block; vertical-align: middle; margin: 0 3px; opacity: 0.85; transition: opacity 0.12s; }
    .icon-link:hover { opacity: 1; filter: drop-shadow(0 1px 2px #ffe06688); }
    .ig-icon, .fb-icon { width: 1.5em; height: 1.5em; display: inline-block; }
    .ig-icon { filter: drop-shadow(0 0 4px #ffe06688); }
    .recent-visit { color: #10b981; font-weight: 500; }
    .never-visited { color: #ef4444; font-weight: 600; }
    .old-visit { color: #f59e0b; font-weight: 500; }
    .text-muted-light { color: #adb5bd !important; } 
    .attended-user-vote { font-size: 0.8em; color: #bbb; margin-left: 5px; }

    @media (max-width: 768px) {
      .header h1 { font-size: 2.2rem; }
      .user-info { position: static; margin: 15px auto; width: fit-content; flex-direction: column; gap: 5px; }
      .user-info button { margin-top: 5px;}
      table { font-size: 0.85rem; }
      .vote-btn { font-size: 0.9rem; padding: 6px 10px; min-width: 80px;}
      .nav-pills .nav-link { padding: 8px 12px; font-size: 0.9rem;}
      .col-md-4, .col-md-8 { width: 100%;} 
      .order-md-1 { order: 0;} 
      .order-md-2 { order: 0;}
    }
  </style>
</head>
<body>
  <div class="overlay"></div>
  <div id="userInfo" class="user-info" style="display: none;"> /* ... (HTML igual que v6) ... */ </div>
  <div id="authContainer" class="auth-container" style="display: none;"> /* ... (HTML igual que v6) ... */ </div>
  <div id="mainContent" class="main-content" style="display: none;"> /* ... (HTML igual que v6, sin el modal de detalles de voto) ... */ </div>

  <script>
    // CAMBIO: Mover estas constantes arriba para claridad y porque se usan en el listener DOMContentLoaded
    const supabaseUrl = 'https://wjwsdyrkqvxszlclitru.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indqd3NkeXJrcXZ4c3psY2xpdHJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0MTA1NzgsImV4cCI6MjA2Mjk4NjU3OH0.YmNDUjkQJrlk91O-Avv7G2QJzQ0R6u9xkR-eIwoAJLo';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
      auth: { 
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
      }
    });

    const bars = [ /* ... (igual que v6) ... */ ];
    let currentUser = null;
    let currentWeek = null;
    let userVotes = []; 
    let userAttendance = false;

    async function init() {
      console.log('üöÄ Iniciando aplicaci√≥n... Intentando obtener sesi√≥n.');
      // CAMBIO: Ocultar body temporalmente para evitar FOUC (flash of unstyled content) o pantalla en blanco moment√°nea
      document.body.style.visibility = 'hidden'; 
      try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
          console.error('‚ùå Error cr√≠tico obteniendo sesi√≥n inicial:', sessionError);
          document.getElementById('mainContent').innerHTML = '<div class="container text-center mt-5 p-4 rounded bg-dark"><p class="text-danger lead">Error al conectar con el servicio de autenticaci√≥n. Por favor, intenta recargar la p√°gina.</p></div>';
          document.getElementById('mainContent').style.display = 'block';
          document.body.style.visibility = 'visible'; // Mostrar el error
          return; 
        }
        console.log('üë§ Sesi√≥n inicial obtenida:', session ? session.user?.email : 'No hay sesi√≥n');
        
        if (session) {
          console.log('üîë Sesi√≥n encontrada, procediendo...');
          await handleAuthSuccess(session);
        } else {
          if (window.location.hash.includes('access_token') || window.location.hash.includes('error_description')) {
            console.log('‚è≥ Token/error detectado en URL (OAuth redirect), onAuthStateChange se encargar√°.');
            // Dejar que onAuthStateChange maneje la visualizaci√≥n
          } else {
            console.log('üîê No hay sesi√≥n activa ni redirecci√≥n OAuth, mostrando pantalla de login.');
            showAuthContainer(); // Esto ya hace visible el body
          }
        }

        supabase.auth.onAuthStateChange(async (event, session) => {
          console.log(`üîÑ Evento AuthStateChange: ${event}`, session ? `Usuario: ${session.user?.email}` : 'Sin sesi√≥n');
          if (event === 'INITIAL_SESSION' && session) {
             console.log('üîë Sesi√≥n persistente cargada (INITIAL_SESSION)');
             await handleAuthSuccess(session);
          } else if (event === 'SIGNED_IN' && session) {
            console.log('‚úÖ Login exitoso (SIGNED_IN)');
            await handleAuthSuccess(session);
          } else if (event === 'SIGNED_OUT') {
            console.log('üëã Logout detectado (SIGNED_OUT)');
            handleSignOut();
          } else if (event === 'TOKEN_REFRESHED' && session) {
            console.log('üîÑ Token refrescado');
            currentUser = session.user;
          } else if (event === 'USER_UPDATED' && session) {
            console.log('üë§ Usuario actualizado');
            currentUser = session.user;
            updateUserInfoDisplay(); 
          }
          // Asegurar que el body sea visible si algo se mostr√≥
          if (document.getElementById('authContainer').style.display === 'block' || document.getElementById('mainContent').style.display === 'block') {
            document.body.style.visibility = 'visible';
          }
        });

      } catch (error) { 
        console.error('‚ùå Error catastr√≥fico en inicializaci√≥n:', error);
        document.getElementById('mainContent').innerHTML = `<div class="container text-center mt-5 p-4 rounded bg-dark"><p class="text-danger lead">Ocurri√≥ un error grave al iniciar la aplicaci√≥n: ${error.message}.<br/>Intenta recargar o revisa la consola.</p></div>`;
        document.getElementById('mainContent').style.display = 'block';
        document.body.style.visibility = 'visible';
      }

      // Fallback por si algo no hizo visible el body
      setTimeout(() => {
        if (document.body.style.visibility === 'hidden') {
            console.warn("El body segu√≠a oculto despu√©s de 3s. Forzando AuthContainer visible.");
            showAuthContainer(); 
        }
      }, 3000);
    }

    function showAuthContainer() {
      document.getElementById('authContainer').style.display = 'block';
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('userInfo').style.display = 'none';
      document.body.style.visibility = 'visible'; // Asegurar que el body sea visible
    }
    
    async function handleAuthSuccess(session) {
      console.log('üéâ Procesando login exitoso...');
      currentUser = session.user;
      try {
        await ensureUserProfile();
        await ensureCurrentWeek();
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('userInfo').style.display = 'flex';
        document.body.style.visibility = 'visible'; // Asegurar que el body sea visible

        updateUserInfoDisplay(); 
        console.log('üìä Cargando datos iniciales...');
        await loadCurrentWeek(); 
        if (currentWeek) { 
             await Promise.all([ loadVotingData(), loadAttendanceData() ]);
        } else {
            console.warn("No se pudo cargar la semana actual.");
            document.getElementById('barsTable').innerHTML = '<tr><td colspan="5" class="text-center text-muted-light">No se pudo cargar la informaci√≥n de la semana.</td></tr>';
        }
        setupEventListeners(); 
        console.log('‚úÖ Todo cargado y configurado correctamente');
      } catch (error) {
        console.error('‚ùå Error en handleAuthSuccess:', error);
        showAuthContainer(); // Revertir a login si algo falla
      }
    }
    
    // ... (resto de funciones JS como ensureUserProfile, ensureCurrentWeek, loadCurrentWeek, 
    //      loadVotingData, loadAttendanceData, igIcon, fbIcon, renderBarsTable, updateWinner,
    //      updateAttendanceUI (con cambios de v6), updateQuorumStatus, toggleVote (con cambios de v5),
    //      loadHistory, loadStats (con cambios de v6), updateStatsUI (con cambios de v6),
    //      formatDate, handleTableClick (con cambios de v6), signOut) ...
    // Aseg√∫rate de que las versiones de estas funciones sean las de v6, con las correcciones
    // para el modal eliminado y el error de loadStats.
    // Por brevedad, no las repetir√© todas aqu√≠, pero la clave es la correcci√≥n del listener del bot√≥n de Google.

    function updateUserInfoDisplay() { /* ... (igual que v6) ... */ }
    async function ensureUserProfile() { /* ... (igual que v6) ... */ }
    async function ensureCurrentWeek() { /* ... (igual que v6) ... */ }
    async function loadCurrentWeek() { /* ... (igual que v6) ... */ }
    async function loadVotingData() { /* ... (igual que v6) ... */ }
    async function loadAttendanceData() { /* ... (igual que v6, con la l√≥gica para obtener votos de asistentes) ... */
        if (!currentUser || !currentWeek) { updateAttendanceUI([]); updateQuorumStatus(0); userAttendance = false; return; }
        try {
            const { data: allVotesThisWeek, error: allVotesError } = await supabase.from('votos').select('user_id, bar').eq('semana_id', currentWeek.id);
            if (allVotesError) { console.error('‚ùå Error cargando todos los votos de la semana:', allVotesError); }
            const { data: attendances, error: attendanceError } = await supabase.from('asistencias').select(`user_id, confirmado, usuarios (nombre, avatar_url)`).eq('semana_id', currentWeek.id).eq('confirmado', true);
            if (attendanceError) throw attendanceError;
            userAttendance = (attendances || []).some(a => a.user_id === currentUser.id);
            const attendeesWithVotes = (attendances || []).map(att => {
                const userSpecificVotes = (allVotesThisWeek || []).filter(vote => vote.user_id === att.user_id).map(vote => vote.bar);
                return { ...att, votedBars: userSpecificVotes };
            });
            updateAttendanceUI(attendeesWithVotes);
            updateQuorumStatus((attendances || []).length);
        } catch (error) { console.error("‚ùå Error en loadAttendanceData:", error); userAttendance = false; updateAttendanceUI([]); updateQuorumStatus(0); }
    }
    function igIcon() { /* ... (igual que v6) ... */ }
    function fbIcon() { /* ... (igual que v6) ... */ }
    function renderBarsTable(allVotesInWeek, barStats) { /* ... (igual que v6, sin data-action=showDetails para el modal) ... */ }
    function updateWinner(allVotesInWeek) { /* ... (igual que v6) ... */ }
    function updateAttendanceUI(attendeesWithVotes) { /* ... (igual que v6, mostrando votedBars) ... */ }
    function updateQuorumStatus(count) { /* ... (igual que v6) ... */ }
    async function toggleVote(barName, btnElement) { /* ... (igual que v5, con logs detallados para delete) ... */ }
    async function loadHistory() { /* ... (igual que v6) ... */ }
    async function loadStats() { /* ... (igual que v6, con la query corregida) ... */ }
    function updateStatsUI(topBars, lastVisits, cnStats) { /* ... (igual que v6, con manejo de error.message) ... */ }
    function formatDate(dateString) { /* ... (igual que v6) ... */ }
    function handleTableClick(event) { /* ... (igual que v6, sin la parte del modal) ... */ }
    function setupEventListeners() { /* ... (igual que v6) ... */ }
    window.signOut = signOut;

    document.addEventListener('DOMContentLoaded', function() {
      console.log('üåê DOM completamente cargado y parseado.');
      
      // CAMBIO: Mover el listener del bot√≥n de Google aqu√≠
      const googleSignInButton = document.getElementById('googleSignIn');
      if (googleSignInButton) {
        googleSignInButton.addEventListener('click', async () => {
          console.log('üîê Bot√≥n Google Sign In clickeado.');
          try {
            const { error } = await supabase.auth.signInWithOAuth({ 
              provider: 'google', 
              options: { 
                redirectTo: window.location.origin, 
                queryParams: { access_type: 'offline', prompt: 'consent' } 
              } 
            });
            if (error) throw error;
          } catch (error) {
            console.error('‚ùå Error al iniciar sesi√≥n con Google:', error);
            alert('Error al iniciar sesi√≥n: ' + error.message);
          }
        });
        console.log('‚úÖ Listener para googleSignIn configurado.');
      } else {
        console.error('‚ùå Bot√≥n googleSignIn no encontrado en el DOM.');
      }

      const tabs = document.querySelectorAll('[data-bs-toggle="pill"]');
      tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
          const target = event.target.getAttribute('data-bs-target');
          if (target === '#history') loadHistory();
          else if (target === '#stats') loadStats();
        });
      });
      console.log('‚úÖ Listeners para tabs configurados.');

      init(); // Iniciar la l√≥gica principal de la aplicaci√≥n
    });
  </script>
</body>
</html>
```

**Cambios Clave en esta Versi√≥n (`v7`):**

1.  **`googleSignIn` Event Listener Movido:**
    * El `document.getElementById('googleSignIn').addEventListener(...)` ahora est√° **dentro** del listener `DOMContentLoaded`. Esto asegura que el bot√≥n HTML existe antes de intentar adjuntarle un evento. Esta es la soluci√≥n directa al error `Cannot read properties of null (reading 'addEventListener')`.

2.  **Manejo de Visibilidad en `init()`:**
    * He a√±adido `document.body.style.visibility = 'hidden';` al principio de `init()` y luego `document.body.style.visibility = 'visible';` cuando `showAuthContainer()` o `handleAuthSuccess()` (o el manejo de errores) deciden mostrar algo. Esto puede ayudar a prevenir un "flash" de contenido incorrecto o una pantalla en blanco mientras se toma la decisi√≥n.
    * Se a√±adi√≥ un fallback con `setTimeout` para mostrar el `authContainer` si despu√©s de unos segundos el `body` sigue oculto, como medida de seguridad.
    * Se mejor√≥ el manejo de `sessionError` en `init()` para mostrar un mensaje de error al usuario si la obtenci√≥n de la sesi√≥n falla cr√≠ticamente.

3.  **Logs de Sesi√≥n Mejorados:**
    * A√±ad√≠ m√°s `console.log` en `init()` y `onAuthStateChange` para que puedas rastrear mejor el flujo de la sesi√≥n, especialmente alrededor del manejo del hash de la URL de OAuth.

**Pr√≥ximos Pasos:**

1.  **Prueba esta versi√≥n (`v7`).**
2.  **Revisa la consola del navegador (F12) INMEDIATAMENTE despu√©s de cargar la p√°gina.**
    * El error de `addEventListener` en la l√≠nea 456 deber√≠a haber desaparecido.
    * Observa los nuevos logs de `init()` y `onAuthStateChange`. ¬øQu√© dicen sobre la sesi√≥n? ¬øSe muestra `authContainer` o `mainContent`?
    * Si la pantalla sigue en blanco, los logs deber√≠an darnos una pista de d√≥nde se detiene la ejecuci√≥n o por qu√© no se est√° mostrando ning√∫n contenedor.
3.  **Si la pantalla sigue en blanco, pero ya no hay errores obvios:**
    * Intenta comentar la l√≠nea `background: url('fondo.png')` en el CSS como te suger√≠ antes, para descartar completamente que sea la imagen.
    * Aseg√∫rate de que los IDs `authContainer` y `mainContent` en tu HTML son correctos y no tienen errores de tipeo.

Con la correcci√≥n del error de `addEventListener`, hay una alta probabilidad de que la pantalla en blanco se resuelva o que al menos veamos un comportamiento m√°s claro en los lo
