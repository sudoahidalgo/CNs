<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>CN - Martes de Birras üçª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><text y='96' font-size='96'>üç∫</text></svg>">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.6/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* MOBILE FIRST DESIGN */
    * {
      box-sizing: border-box;
    }
    
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      background-attachment: fixed;
      color: #fff;
      overflow-x: hidden;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    /* Header m√≥vil compacto */
    .mobile-header {
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      padding: 12px 16px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      border-bottom: 1px solid rgba(255, 224, 102, 0.3);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .app-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #ffe066;
      margin: 0;
    }

    .week-info {
      font-size: 0.8rem;
      color: #adb5bd;
      margin-top: 2px;
    }

    .user-avatar-mobile {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid #ffe066;
      background-color: #555;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      font-size: 0.8rem;
      overflow: hidden;
    }

    .user-avatar-mobile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Main content area */
    .main-content {
      flex: 1;
      padding: 80px 0 80px 0; /* Space for header and bottom nav */
      overflow-y: auto;
    }

    .content-section {
      padding: 16px;
      display: none;
    }

    .content-section.active {
      display: block;
    }

    /* Winner message - solo cuando hay ganador claro */
    .winner-banner {
      background: linear-gradient(135deg, #10b981, #059669);
      margin: 0 16px 16px 16px;
      padding: 12px 16px;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 224, 102, 0.3);
      padding: 8px 0;
      z-index: 1000;
    }

    .nav-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
      max-width: 500px;
      margin: 0 auto;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 8px;
      min-width: 60px;
    }

    .nav-item.active {
      background: rgba(255, 224, 102, 0.15);
      color: #ffe066;
    }

    .nav-item:not(.active) {
      color: #adb5bd;
    }

    .nav-icon {
      font-size: 1.3rem;
      margin-bottom: 2px;
    }

    .nav-label {
      font-size: 0.7rem;
      font-weight: 500;
      text-align: center;
    }

    /* Voting Section */
    .bars-grid {
      display: grid;
      gap: 12px;
      padding: 0;
    }

    .bar-card {
      background: rgba(40, 40, 40, 0.9);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .bar-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .bar-name {
      font-weight: 600;
      font-size: 1rem;
      color: #fff;
      flex: 1;
    }

    .bar-votes {
      background: rgba(255, 224, 102, 0.2);
      color: #ffe066;
      padding: 4px 8px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      min-width: 30px;
      text-align: center;
      cursor: pointer;
    }

    .bar-votes.has-votes:hover {
      background: rgba(255, 224, 102, 0.3);
    }

    .bar-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .vote-btn-mobile {
      flex: 1;
      background: #008d4e;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .vote-btn-mobile.voted {
      background: #c0392b;
    }

    .vote-btn-mobile:disabled {
      background: #555;
      color: #aaa;
      cursor: not-allowed;
    }

    .vote-btn-mobile:not(:disabled):active {
      transform: scale(0.95);
    }

    .social-links {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .social-icon {
      width: 24px;
      height: 24px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .social-icon:hover {
      opacity: 1;
    }

    .last-visit-mobile {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 8px;
    }

    /* Attendance Section */
    .quorum-card {
      background: rgba(40, 40, 40, 0.9);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
    }

    .quorum-status-mobile {
      font-size: 1rem;
      font-weight: 600;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .quorum-yes { background: rgba(0, 141, 78, 0.3); color: #4ade80; }
    .quorum-no { background: rgba(239, 68, 68, 0.3); color: #f87171; }
    .quorum-pending { background: rgba(234, 179, 8, 0.3); color: #facc15; }

    .attendees-list {
      display: grid;
      gap: 8px;
    }

    .attendee-item {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      padding: 12px;
      border-radius: 8px;
    }

    .attendee-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.8rem;
      margin-right: 12px;
      border: 1px solid rgba(255, 224, 102, 0.5);
    }

    .attendee-name {
      font-weight: 500;
    }

    /* Stats Section */
    .stats-grid {
      display: grid;
      gap: 16px;
    }

    .stat-card {
      background: rgba(40, 40, 40, 0.9);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-title {
      color: #ffe066;
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-badge {
      background: rgba(255, 224, 102, 0.2);
      color: #ffe066;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    /* History Section */
    .history-item {
      background: rgba(40, 40, 40, 0.9);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .history-date {
      font-weight: 600;
      color: #ffe066;
      margin-bottom: 8px;
    }

    .history-result {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .history-stats {
      font-size: 0.8rem;
      color: #adb5bd;
    }

    /* Auth Container */
    .auth-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 32px 24px;
      text-align: center;
    }

    .auth-card {
      background: rgba(40, 40, 40, 0.9);
      border-radius: 20px;
      padding: 32px 24px;
      max-width: 400px;
      width: 100%;
      border: 2px solid rgba(255, 224, 102, 0.3);
    }

    .auth-title {
      font-size: 2rem;
      color: #ffe066;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .auth-subtitle {
      color: #adb5bd;
      margin-bottom: 32px;
      font-size: 0.9rem;
    }

    .google-btn {
      background: linear-gradient(45deg, #4285f4, #34a853);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      padding: 14px 24px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      transition: all 0.3s ease;
    }

    .google-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(66, 133, 244, 0.4);
    }

    .google-icon {
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #4285f4;
      font-size: 0.9rem;
    }

    /* Loading states */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: #adb5bd;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #555;
      border-top: 2px solid #ffe066;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive adjustments */
    @media (min-width: 768px) {
      .bars-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 1024px) {
      .app-container {
        max-width: 800px;
        margin: 0 auto;
      }
      
      .bars-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Dark colors for visit status */
    .recent-visit { color: #10b981; font-weight: 500; }
    .never-visited { color: #ef4444; font-weight: 600; }
    .old-visit { color: #f59e0b; font-weight: 500; }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Auth Screen -->
    <div id="authContainer" class="auth-container" style="display: none;">
      <div class="auth-card">
        <h1 class="auth-title">üçª Martes de Birras</h1>
        <p class="auth-subtitle">Vota por tu bar favorito y confirma tu asistencia</p>
        <button id="googleSignIn" class="google-btn">
          <div class="google-icon">G</div>
          <span>Continuar con Google</span>
        </button>
      </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
      <!-- Mobile Header -->
      <header class="mobile-header">
        <div class="header-content">
          <div>
            <h1 class="app-title">üçª Martes de Birras</h1>
            <div id="weekInfo" class="week-info"></div>
          </div>
          <div class="user-avatar-mobile" id="userAvatarMobile" onclick="signOut()">
          </div>
        </div>
      </header>

      <!-- Winner Banner (solo cuando hay ganador claro) -->
      <div id="winnerBanner" class="winner-banner" style="display: none;"></div>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Votaci√≥n Tab -->
        <section id="votingSection" class="content-section active">
          <div id="barsContainer" class="bars-grid">
            <div class="loading">
              <div class="spinner"></div>
              <span>Cargando bares...</span>
            </div>
          </div>
        </section>

        <!-- Asistencia Tab -->
        <section id="attendanceSection" class="content-section">
          <div class="quorum-card">
            <div id="quorumStatusMobile" class="quorum-status-mobile"></div>
            <div id="attendeesListMobile" class="attendees-list"></div>
          </div>
        </section>

        <!-- Historial Tab -->
        <section id="historySection" class="content-section">
          <div id="historyContainer">
            <div class="loading">
              <div class="spinner"></div>
              <span>Cargando historial...</span>
            </div>
          </div>
        </section>

        <!-- Estad√≠sticas Tab -->
        <section id="statsSection" class="content-section">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-title">üèÜ Top Bares</div>
              <div id="topBarsMobile">
                <div class="loading">
                  <div class="spinner"></div>
                  <span>Cargando...</span>
                </div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-title">‚è∞ √öltimas Visitas</div>
              <div id="lastVisitsMobile">
                <div class="loading">
                  <div class="spinner"></div>
                  <span>Cargando...</span>
                </div>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-title">üìä Estad√≠sticas CN</div>
              <div id="cnStatsMobile">
                <div class="loading">
                  <div class="spinner"></div>
                  <span>Cargando...</span>
                </div>
              </div>
            </div>
          </div>
        </section>
      </main>

      <!-- Bottom Navigation -->
      <nav class="bottom-nav">
        <div class="nav-items">
          <div class="nav-item active" data-section="voting">
            <div class="nav-icon">üó≥Ô∏è</div>
            <div class="nav-label">Votaci√≥n</div>
          </div>
          <div class="nav-item" data-section="attendance">
            <div class="nav-icon">üë•</div>
            <div class="nav-label">Asistencia</div>
          </div>
          <div class="nav-item" data-section="history">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">Historial</div>
          </div>
          <div class="nav-item" data-section="stats">
            <div class="nav-icon">üìà</div>
            <div class="nav-label">Stats</div>
          </div>
        </div>
      </nav>
    </div>
  </div>

  <script>
    // ========== CONFIGURACI√ìN SUPABASE ==========
    const supabaseUrl = 'https://wjwsdyrkqvxszlclitru.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indqd3NkeXJrcXZ4c3psY2xpdHJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc0MTA1NzgsImV4cCI6MjA2Mjk4NjU3OH0.YmNDUjkQJrlk91O-Avv7G2QJzQ0R6u9xkR-eIwoAJLo';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const bars = [
      { name: "Hooligans Alas", ig: "https://www.instagram.com/hooligans_cr/" },
      { name: "Distrito Federal", fb: "https://www.facebook.com/distritofederalcr/" }, 
      { name: "Old West", ig: "https://www.instagram.com/oldwestcr/?hl=en" },
      { name: "El Jard√≠n", ig: "https://www.instagram.com/el_jardin_bar_y_restaurante/" },
      { name: "Stiefel", ig: "https://www.instagram.com/stiefelpubcr/" },
      { name: "CRCC", ig: "https://www.instagram.com/elcountrycr/" },
      { name: "Pocket", ig: "https://www.instagram.com/pocketcostarica/" },
      { name: "La Planta", ig: "https://www.instagram.com/laplantacrcb/" },
      { name: "Rio de J", ig: "https://www.instagram.com/rioescazu/" },
      { name: "Tap House City", ig: "https://www.instagram.com/taphousecr/" },
      { name: "Eremita", ig: "https://www.instagram.com/eremita.cerveza/" },
      { name: "Zompopas", ig: "" },
      { name: "Casa Adri√°n" },
      { name: "Casa Nino" },
      { name: "Soberanos", ig: "https://www.instagram.com/soberanosbrewers/" },
      { name: "Cebolla Verde", ig: "https://www.instagram.com/cebollaverdecr/" },
      { name: "Hoppys", ig: "https://www.instagram.com/hoppys_place/" },
      { name: "CharlesBBQ", ig: "https://www.instagram.com/charlesbbqcr/" },
      { name: "El Pub Escazu" },
      { name: "Chubbs", ig: "https://www.instagram.com/chubbssportabar/" },
      { name: "Maxi's by Ricky", ig: "https://www.instagram.com/maxisbyricky/" },
      { name: "Bar La Playa", ig: "https://www.instagram.com/laplayasantaanacr/" }
    ];

    let currentUser = null;
    let currentWeek = null;
    let userVotes = []; 
    let userAttendance = false;
    let currentSection = 'voting';

    // ========== INITIALIZATION ==========
    async function init() {
      console.log('üöÄ Iniciando aplicaci√≥n m√≥vil...');
      
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) console.error('‚ùå Error obteniendo sesi√≥n:', error);
        
        if (session) {
          await handleAuthSuccess(session);
        } else {
          showAuthContainer();
        }

        // Auth state listener
        supabase.auth.onAuthStateChange(async (event, session) => {
          console.log('üîÑ Auth change:', event);
          if (event === 'SIGNED_IN' && session) {
            await handleAuthSuccess(session);
          } else if (event === 'SIGNED_OUT') {
            handleSignOut();
          } else if (event === 'TOKEN_REFRESHED' && session) {
            currentUser = session.user;
            updateUserDisplay();
          }
        });

        // Setup navigation
        setupBottomNavigation();
        
      } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
        showAuthContainer();
      }
    }

    function showAuthContainer() {
      document.getElementById('authContainer').style.display = 'flex';
      document.getElementById('mainApp').style.display = 'none';
    }

    function showMainApp() {
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
    }

    function handleSignOut() {
      currentUser = null;
      currentWeek = null;
      userVotes = [];
      userAttendance = false;
      showAuthContainer();
    }

    async function handleAuthSuccess(session) {
      console.log('üéâ Login exitoso');
      currentUser = session.user;
      
      try {
        await ensureUserProfile();
        await ensureCurrentWeek();
        await loadCurrentWeek();
        
        showMainApp();
        updateUserDisplay();
        
        // Load initial data
        if (currentWeek) {
          await Promise.all([
            loadVotingData(),
            loadAttendanceData()
          ]);
        }
        
        console.log('‚úÖ App cargada');
      } catch (error) {
        console.error('‚ùå Error en handleAuthSuccess:', error);
        showAuthContainer();
      }
    }

    function updateUserDisplay() {
      if (!currentUser) return;
      
      const avatarEl = document.getElementById('userAvatarMobile');
      if (avatarEl) {
        const avatarUrl = currentUser.user_metadata?.avatar_url;
        if (avatarUrl) {
          avatarEl.innerHTML = `<img src="${avatarUrl}" alt="Avatar" onerror="this.outerHTML='<div class=&quot;user-avatar-mobile&quot;>${(currentUser.email || 'U').charAt(0).toUpperCase()}</div>'">`;
        } else {
          avatarEl.textContent = (currentUser.email || 'U').charAt(0).toUpperCase();
        }
      }
    }

    // ========== NAVIGATION ==========
    function setupBottomNavigation() {
      const navItems = document.querySelectorAll('.nav-item');
      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const section = item.dataset.section;
          switchToSection(section);
        });
      });
    }

    function switchToSection(sectionName) {
      // Update navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-section="${sectionName}"]`).classList.add('active');
      
      // Update content
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${sectionName}Section`).classList.add('active');
      
      currentSection = sectionName;
      
      // Load data for section if needed
      if (sectionName === 'history' && currentUser) {
        loadHistory();
      } else if (sectionName === 'stats' && currentUser) {
        loadStats();
      }
    }

    // ========== DATE FUNCTIONS ==========
    function getNextTuesday() {
      const today = new Date();
      const dayOfWeek = today.getDay();
      let daysUntilTuesday;
      
      if (dayOfWeek <= 2) {
        daysUntilTuesday = 2 - dayOfWeek;
      } else {
        daysUntilTuesday = 7 - dayOfWeek + 2;
      }
      
      const nextTuesday = new Date(today);
      nextTuesday.setDate(today.getDate() + daysUntilTuesday);
      return nextTuesday;
    }

    function formatTuesdayDate(date) {
      const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
      const day = date.getDate().toString().padStart(2, '0');
      const month = months[date.getMonth()];
      return `${day}-${month}`;
    }

    // ========== DATA LOADING ==========
    async function ensureUserProfile() {
      try {
        const { data, error } = await supabase
          .from('usuarios')
          .select('*')
          .eq('id', currentUser.id)
          .single();
        
        if (error && error.code !== 'PGRST116') throw error;
        
        if (!data) {
          const { error: insertError } = await supabase
            .from('usuarios')
            .insert({
              id: currentUser.id,
              email: currentUser.email,
              nombre: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
              avatar_url: currentUser.user_metadata?.avatar_url
            });
          if (insertError) throw insertError;
        }
      } catch (error) {
        console.error('‚ùå Error en ensureUserProfile:', error);
      }
    }

    async function ensureCurrentWeek() {
      try {
        await supabase.rpc('crear_semana_si_no_existe');
        await supabase.rpc('finalizar_semana_anterior');
      } catch (error) {
        console.error('‚ùå Error en ensureCurrentWeek:', error);
      }
    }

    async function loadCurrentWeek() {
      try {
        const { data, error } = await supabase
          .from('semana_actual')
          .select('*')
          .single();
        
        if (error) {
          console.error('‚ùå Error cargando semana:', error);
          return;
        }
        
        currentWeek = data;
        
        // Update week info
        const weekInfoEl = document.getElementById('weekInfo');
        if (weekInfoEl) {
          const nextTuesday = getNextTuesday();
          const formattedDate = formatTuesdayDate(nextTuesday);
          weekInfoEl.textContent = `Pr√≥ximo martes ${formattedDate} ‚Ä¢ ${currentWeek.estado.toUpperCase()}`;
        }
      } catch (error) {
        console.error('‚ùå Error en loadCurrentWeek:', error);
      }
    }

    async function loadVotingData() {
      if (!currentUser || !currentWeek) return;
      
      try {
        const { data: votesInWeek, error } = await supabase
          .from('votos')
          .select('bar, user_id')
          .eq('semana_id', currentWeek.id);
        
        if (error) throw error;
        
        userVotes = (votesInWeek || [])
          .filter(v => v.user_id === currentUser.id)
          .map(v => v.bar);
        
        const { data: barStats, error: statsError } = await supabase
          .from('estadisticas_bares')
          .select('*');
        
        if (statsError) console.error('Error loading bar stats:', statsError);
        
        renderBarsGrid(votesInWeek || [], barStats || []);
        updateWinnerBanner(votesInWeek || []);
        
      } catch (error) {
        console.error('‚ùå Error en loadVotingData:', error);
        document.getElementById('barsContainer').innerHTML = '<div class="loading">Error cargando datos</div>';
      }
    }

    async function loadAttendanceData() {
      if (!currentUser || !currentWeek) return;
      
      try {
        const { data: attendances, error } = await supabase
          .from('asistencias')
          .select('user_id, confirmado, usuarios (nombre, avatar_url)')
          .eq('semana_id', currentWeek.id)
          .eq('confirmado', true);
        
        if (error) throw error;
        
        userAttendance = (attendances || []).some(a => a.user_id === currentUser.id);
        
        updateAttendanceUI(attendances || []);
        updateQuorumStatus((attendances || []).length);
        
      } catch (error) {
        console.error('‚ùå Error en loadAttendanceData:', error);
      }
    }

    // ========== UI RENDERING ==========
    function renderBarsGrid(allVotes, barStats) {
      const container = document.getElementById('barsContainer');
      if (!container) return;
      
      // Count votes
      const voteCounts = {};
      allVotes.forEach(vote => {
        voteCounts[vote.bar] = (voteCounts[vote.bar] || 0) + 1;
      });
      
      // Create stats map
      const statsMap = {};
      barStats.forEach(stat => {
        statsMap[stat.bar] = stat;
      });
      
      // Sort bars by votes
      const sortedBars = bars.slice().sort((a, b) => {
        const aVotes = voteCounts[a.name] || 0;
        const bVotes = voteCounts[b.name] || 0;
        if (bVotes !== aVotes) return bVotes - aVotes;
        return a.name.localeCompare(b.name);
      });
      
      container.innerHTML = sortedBars.map(bar => {
        const votes = voteCounts[bar.name] || 0;
        const userVoted = userVotes.includes(bar.name);
        const stats = statsMap[bar.name];
        const isActive = currentWeek?.estado === 'activa';
        
        // Social links
        let socialLinks = '';
        if (bar.ig) socialLinks += `<a href="${bar.ig}" target="_blank">${igIcon()}</a>`;
        if (bar.fb) socialLinks += `<a href="${bar.fb}" target="_blank">${fbIcon()}</a>`;
        
        // Last visit
        let lastVisit = '<span class="never-visited">Nunca</span>';
        if (stats?.ultima_visita) {
          const days = stats.dias_desde_ultima_visita;
          const dateStr = formatDate(stats.ultima_visita);
          if (days <= 14) lastVisit = `<span class="recent-visit">${dateStr} (${days}d)</span>`;
          else if (days <= 60) lastVisit = `<span class="old-visit">${dateStr} (${days}d)</span>`;
          else lastVisit = `<span class="last-visit">${dateStr} (${days}d)</span>`;
        }
        
        return `
          <div class="bar-card">
            <div class="bar-header">
              <div class="bar-name">${bar.name}</div>
              <div class="bar-votes ${votes > 0 ? 'has-votes' : ''}" 
                   ${votes > 0 ? `onclick="showVoteDetails('${bar.name}', ${votes})"` : ''}>
                ${votes}
              </div>
            </div>
            <div class="bar-actions">
              <button class="vote-btn-mobile ${userVoted ? 'voted' : ''}"
                      ${!isActive ? 'disabled' : ''}
                      onclick="toggleVote('${bar.name}', this)">
                ${userVoted ? 'üç∫ Quitar' : 'üí™ Votar'}
              </button>
              <div class="social-links">${socialLinks}</div>
            </div>
            <div class="last-visit-mobile">√öltima visita: ${lastVisit}</div>
          </div>
        `;
      }).join('');
    }

    // Winner banner - solo mostrar cuando hay un ganador claro (no empate)
    function updateWinnerBanner(allVotes) {
      const banner = document.getElementById('winnerBanner');
      if (!banner) return;
      
      if (!allVotes.length) {
        banner.style.display = 'none';
        return;
      }
      
      const voteCounts = {};
      allVotes.forEach(vote => {
        voteCounts[vote.bar] = (voteCounts[vote.bar] || 0) + 1;
      });
      
      const maxVotes = Math.max(...Object.values(voteCounts));
      const winners = Object.keys(voteCounts).filter(bar => voteCounts[bar] === maxVotes);
      
      // Solo mostrar si hay UN ganador claro (no empate)
      if (winners.length === 1 && maxVotes > 0) {
        banner.innerHTML = `üèÜ Ganador: <strong>${winners[0]}</strong> (${maxVotes} votos)`;
        banner.style.display = 'block';
      } else {
        banner.style.display = 'none';
      }
    }

    function updateAttendanceUI(attendances) {
      const container = document.getElementById('attendeesListMobile');
      if (!container) return;
      
      if (!attendances.length) {
        container.innerHTML = '<div style="text-align: center; color: #adb5bd; padding: 20px;">Nadie ha confirmado asistencia a√∫n</div>';
        return;
      }
      
      container.innerHTML = attendances.map(att => {
        let userName = 'Usuario';
        if (att.usuarios?.nombre) {
          userName = att.usuarios.nombre.toString().trim().replace(/^['">]+|['">]+$/g, '');
          if (!userName) userName = 'Usuario';
        }
        
        const avatarUrl = att.usuarios?.avatar_url;
        const firstLetter = userName.charAt(0).toUpperCase();
        
        return `
          <div class="attendee-item">
            <div class="attendee-avatar">
              ${avatarUrl ? `<img src="${avatarUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.outerHTML='${firstLetter}'">` : firstLetter}
            </div>
            <div class="attendee-name">${userName}</div>
          </div>
        `;
      }).join('');
    }

    function updateQuorumStatus(count) {
      const statusEl = document.getElementById('quorumStatusMobile');
      if (!statusEl) return;
      
      const needed = 3;
      
      if (count >= needed) {
        statusEl.className = 'quorum-status-mobile quorum-yes';
        statusEl.textContent = `‚úÖ ¬°Hay quorum! ${count} confirmados`;
      } else if (count > 0) {
        statusEl.className = 'quorum-status-mobile quorum-pending';
        statusEl.textContent = `‚è≥ ${count} confirmados, faltan ${needed - count}`;
      } else {
        statusEl.className = 'quorum-status-mobile quorum-no';
        statusEl.textContent = `‚ùå Se necesitan ${needed} para hacer CN`;
      }
    }

    // ========== VOTE HANDLING ==========
    async function toggleVote(barName, btnElement) {
      if (!currentWeek || currentWeek.estado !== 'activa' || !currentUser) {
        alert('No se puede votar en este momento');
        return;
      }

      const originalText = btnElement.textContent;
      btnElement.textContent = '‚è≥';
      btnElement.disabled = true;

      try {
        const userVoted = userVotes.includes(barName);
        
        if (userVoted) {
          // Remove vote
          const { error } = await supabase
            .from('votos')
            .delete()
            .match({ user_id: currentUser.id, semana_id: currentWeek.id, bar: barName });
          
          if (error) throw error;
          
          userVotes = userVotes.filter(v => v !== barName);
          
          // Remove attendance if no votes left
          if (userVotes.length === 0) {
            await supabase
              .from('asistencias')
              .delete()
              .match({ user_id: currentUser.id, semana_id: currentWeek.id });
            userAttendance = false;
          }
        } else {
          // Add vote
          const { error } = await supabase
            .from('votos')
            .insert({ user_id: currentUser.id, semana_id: currentWeek.id, bar: barName });
          
          if (error) throw error;
          
          userVotes.push(barName);
          
          // Ensure attendance
          if (!userAttendance) {
            const { data: existing } = await supabase
              .from('asistencias')
              .select('id')
              .match({ user_id: currentUser.id, semana_id: currentWeek.id })
              .single();
            
            if (!existing) {
              await supabase
                .from('asistencias')
                .insert({ user_id: currentUser.id, semana_id: currentWeek.id, confirmado: true });
            }
            userAttendance = true;
          }
        }
        
        // Reload data
        await Promise.all([loadVotingData(), loadAttendanceData()]);
        
      } catch (error) {
        console.error('‚ùå Error en toggleVote:', error);
        alert('Error al procesar voto: ' + error.message);
        btnElement.textContent = originalText;
        btnElement.disabled = false;
      }
    }

    async function showVoteDetails(barName, voteCount) {
      // Simplified modal or alert for mobile
      alert(`${voteCount} personas han votado por ${barName}`);
    }

    // ========== STATS & HISTORY ==========
    async function loadHistory() {
      const container = document.getElementById('historyContainer');
      if (!container) return;
      
      try {
        const { data: weeks, error } = await supabase
          .from('semanas_cn')
          .select('*')
          .eq('estado', 'finalizada')
          .order('fecha_martes', { ascending: false })
          .limit(10);
        
        if (error) throw error;
        
        if (!weeks?.length) {
          container.innerHTML = '<div class="loading">No hay historial disponible</div>';
          return;
        }
        
        container.innerHTML = weeks.map(week => `
          <div class="history-item">
            <div class="history-date">${formatDate(week.fecha_martes)}</div>
            <div class="history-result">
              ${week.hubo_quorum && week.bar_ganador ? 
                `üèÜ Ganador: ${week.bar_ganador}` : 
                (week.hubo_quorum ? 'ü§î Sin ganador claro' : '‚ùå Sin quorum')}
            </div>
            <div class="history-stats">
              üë• ${week.total_asistentes || 0} asistentes ‚Ä¢ üó≥Ô∏è ${week.total_votos || 0} votos
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('‚ùå Error loading history:', error);
        container.innerHTML = '<div class="loading">Error cargando historial</div>';
      }
    }

    async function loadStats() {
      try {
        const [topBarsRes, lastVisitsRes, cnStatsRes] = await Promise.all([
          supabase.from('visitas_bares').select('bar, COUNT(*) as visitas').group('bar').order('visitas', { ascending: false }).limit(5),
          supabase.from('estadisticas_bares').select('*').order('ultima_visita', { ascending: false, nullsFirst: true }).limit(5),
          supabase.from('semanas_cn').select('*').eq('estado', 'finalizada')
        ]);
        
        // Top bars
        const topBarsEl = document.getElementById('topBarsMobile');
        if (topBarsEl) {
          if (topBarsRes.data?.length) {
            topBarsEl.innerHTML = topBarsRes.data.map((bar, i) => `
              <div class="stat-item">
                <span>${i + 1}. ${bar.bar}</span>
                <span class="stat-badge">${bar.visitas}</span>
              </div>
            `).join('');
          } else {
            topBarsEl.innerHTML = '<div style="text-align:center;color:#adb5bd;">Sin datos</div>';
          }
        }
        
        // Last visits
        const lastVisitsEl = document.getElementById('lastVisitsMobile');
        if (lastVisitsEl) {
          if (lastVisitsRes.data?.length) {
            lastVisitsEl.innerHTML = lastVisitsRes.data.map(bar => {
              let visitText = 'Nunca';
              if (bar.ultima_visita) {
                const days = bar.dias_desde_ultima_visita;
                if (days <= 14) visitText = `${days}d`;
                else if (days <= 60) visitText = `${days}d`;
                else visitText = `${days}d`;
              }
              return `
                <div class="stat-item">
                  <span>${bar.bar}</span>
                  <span class="stat-badge">${visitText}</span>
                </div>
              `;
            }).join('');
          } else {
            lastVisitsEl.innerHTML = '<div style="text-align:center;color:#adb5bd;">Sin datos</div>';
          }
        }
        
        // CN Stats
        const cnStatsEl = document.getElementById('cnStatsMobile');
        if (cnStatsEl) {
          const totalCNs = cnStatsRes.data?.length || 0;
          const withQuorum = cnStatsRes.data?.filter(cn => cn.hubo_quorum).length || 0;
          
          cnStatsEl.innerHTML = `
            <div class="stat-item">
              <span>CNs realizadas</span>
              <span class="stat-badge">${totalCNs}</span>
            </div>
            <div class="stat-item">
              <span>Con quorum</span>
              <span class="stat-badge">${withQuorum}</span>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('‚ùå Error loading stats:', error);
      }
    }

    // ========== UTILITY FUNCTIONS ==========
    function igIcon() {
      return `<svg class="social-icon" viewBox="0 0 24 24" fill="none"><rect x="2" y="2" width="20" height="20" rx="5" stroke="currentColor" stroke-width="2"/><path d="M16 11.37-4 4v-8.74l4 4.74z" fill="currentColor"/><circle cx="17.5" cy="6.5" r="1.5" fill="currentColor"/></svg>`;
    }

    function fbIcon() {
      return `<svg class="social-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>`;
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      try {
        return new Date(dateString).toLocaleDateString('es-ES', {
          weekday: 'short',
          month: 'short',
          day: 'numeric'
        });
      } catch {
        return dateString;
      }
    }

    async function signOut() {
      try {
        await supabase.auth.signOut();
      } catch (error) {
        console.error('‚ùå Error signing out:', error);
      }
    }

    // ========== EVENT LISTENERS ==========
    document.addEventListener('DOMContentLoaded', () => {
      // Google Sign In
      document.getElementById('googleSignIn').addEventListener('click', async () => {
        try {
          const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: window.location.origin
            }
          });
          if (error) throw error;
        } catch (error) {
          console.error('‚ùå Error signing in:', error);
          alert('Error al iniciar sesi√≥n: ' + error.message);
        }
      });

      // Initialize app
      init();
    });

    // Make functions globally available
    window.toggleVote = toggleVote;
    window.showVoteDetails = showVoteDetails;
    window.signOut = signOut;
  </script>
</body>
</html>
